{% extends 'backend/layouts/app.html' %}
{% load static %}
{% load humanize %}
{% block content %}

<div class="container-fluid">
	<div class="list-product-header mb-4">
		<div class="d-flex justify-content-between align-items-center">
			<h4>Application Details</h4>
			{% if user.role == 'Admin' %}
				<a class="btn btn-secondary" href="{% url 'backend:getRentApplications' %}">
					<i class="fa fa-arrow-left"></i> Back to Applications
				</a>
			{% elif user.role == 'House Provider' %}
				<a class="btn btn-secondary" href="{% url 'backend:getRentApplications' %}">
					<i class="fa fa-arrow-left"></i> Back to Applications
				</a>
			{% elif user.role == 'User' %}
				<a class="btn btn-secondary" href="{% url 'users:getApplications' %}">
					<i class="fa fa-arrow-left"></i> Back to Applications
				</a>
			{% endif %}
			<button id="downloadReportBtn" class="btn btn-info">
				<i class="fa fa-download"></i> Download Report
			</button>
		</div>
	</div>
	<div class="row">
		<div class="col-md-6">
			<div class="card">
				<div class="card-body">
					<div class="product-slider owl-carousel owl-theme" id="sync1">
						{% if application.property.images.all %}
							{% for image in application.property.images.all %}
								<div class="item">
									<img src="{{ image.image.url }}" alt="">
								</div>
							{% endfor %}
						{% else %}
								<img src="https://salonlfc.com/wp-content/uploads/2018/01/image-not-found-scaled.png" alt="{{ application.property.name }}">
						{% endif %}
					</div>
					<div class="owl-carousel owl-theme" id="sync2">
						{% if application.property.images.all %}
							{% for image in application.property.images.all %}
								<div class="item">
									<img src="{{ image.image.url }}" alt="">
								</div>
							{% endfor %}
						{% else %}
								<img src="https://salonlfc.com/wp-content/uploads/2018/01/image-not-found-scaled.png" alt="{{ application.property.name }}">
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card mb-4">
				<div class="card-header">
					<h6>Applicant Information</h6>
				</div>
				<div class="card-body">
					<div class="row mb-3">
						{% if application.id_number_image %}
						<div class="col-sm-6 text-center">
							<label class="form-label">ID Document</label>
							<img src="{{ application.id_number_image.url }}" class="img-fluid rounded" alt="ID Document">
						</div>
						{% endif %}
						{% if application.applicant_image %}
						<div class="col-sm-6 text-center">
							<label class="form-label">Applicant Photo</label>
							<img src="{{ application.applicant_image.url }}" class="img-fluid rounded-circle" style="width:120px" alt="Applicant Photo">
						</div>
						{% endif %}
					</div>
					<table class="table">
						<tbody>
							<tr>
								<th>Marital Status</th>
								<td>{{ application.marital_status }}</td>
							</tr>
							<tr>
								<th>Employment Status</th>
								<td>{{ application.employment_status }}</td>
							</tr>
							{% if application.monthly_income %}
							<tr>
								<th>Monthly Income</th>
								<td>${{ application.monthly_income }}</td>
							</tr>
							{% endif %}
							<tr>
								<th>Has Children?</th>
								<td>{{ application.has_children|yesno:"Yes,No" }}</td>
							</tr>
							{% if application.has_children %}
							<tr>
								<th>Number of Children</th>
								<td>{{ application.number_of_children }}</td>
							</tr>
							{% endif %}
							<tr>
								<th>Has Pet?</th>
								<td>{{ application.has_pet|yesno:"Yes,No" }}</td>
							</tr>
							{% if application.has_pet %}
							<tr>
								<th>Pet Details</th>
								<td>{{ application.pet_details }}</td>
							</tr>
							{% endif %}
							<tr>
								<th>Has Disability?</th>
								<td>{{ application.has_disability|yesno:"Yes,No" }}</td>
							</tr>
							{% if application.has_disability %}
							<tr>
								<th>Disability Details</th>
								<td>{{ application.disability_details }}</td>
							</tr>
							{% endif %}
							{% if application.references %}
							<tr>
								<th>References</th>
								<td>{{ application.references|linebreaksbr }}</td>
							</tr>
							{% endif %}
							{% if application.message %}
							<tr>
								<th>Additional Message</th>
								<td>{{ application.message|linebreaksbr }}</td>
							</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">{{ application.property.name }}</h5>
					<p class="text-muted">{{ application.property.address }}</p>
					<table class="table table-borderless">
						<tbody>
							<tr>
								<th>Applicant Name:</th>
								<td>{{ application.user.name }}</td>
							</tr>
							<tr>
								<th>Email:</th>
								<td>{{ application.user.email }}</td>
							</tr>
							<tr>
								<th>Phone:</th>
								<td>{{ application.user.phone_number }}</td>
							</tr>
							<tr>
								<th>Status:</th>
								<td>
									<span class="badge 
										{% if application.status == 'Accepted' %}badge-success
										{% elif application.status == 'Rejected' %}badge-danger
										{% elif application.status == 'Moved Out' %}badge-warning
										{% else %}badge-secondary{% endif %}">
									{{ application.status }}
									</span>
								</td>
							</tr>
							<tr>
								<th>Preferred Move-In:</th>
								<td>{{ application.preferred_move_in_date }}</td>
							</tr>
							<tr>
								<th>Rental Period:</th>
								<td>{{ application.rental_period_months }} month(s)</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<!-- Status Update Form (Admin / Owner) -->
			{% if request.user.role == 'Admin' or application.property.created_by == request.user %}
				<div class="card">
					<div class="card-body">
						<form method="post">
							{% csrf_token %}
							<div class="mb-3">
								<label for="status" class="form-label">Update Application Status</label>
								<select name="status" id="status" class="form-select">
								<option value="Pending" {% if application.status == 'Pending' %}selected{% endif %}>Pending</option>
								<option value="Accepted" {% if application.status == 'Accepted' %}selected{% endif %}>Accepted</option>
								<option value="Rejected" {% if application.status == 'Rejected' %}selected{% endif %}>Rejected</option>
								<option value="Moved Out" {% if application.status == 'Moved Out' %}selected{% endif %}>Moved Out</option>
								</select>
							</div>
							<button type="submit" class="btn btn-primary">Save Status</button>
						</form>
					</div>
				</div>
			{% endif %}
		</div>
	</div>
</div>

<script>
document.getElementById('downloadReportBtn').addEventListener('click', function() {
    // Grab the main container with the application details
    const container = document.querySelector('.container-fluid');

    // Clone the container so we donâ€™t mess with the live DOM
    const clone = container.cloneNode(true);

    // Remove any interactive elements not needed in the report (like buttons)
    clone.querySelectorAll('button, form, select, input').forEach(el => el.remove());

    // Clean up carousel elements or images that might be dynamically loaded (optional)
    // For simplicity, just keep images with their src.

    // Create a HTML template for the report
    const htmlContent = `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Application Report - ${document.title}</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 2rem;
                color: #333;
                background-color: #fff;
            }
            h4, h5, h6 {
                color: #004085;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #007bff;
                color: white;
            }
            img {
                max-width: 100%;
                height: auto;
                margin: 10px 0;
                border-radius: 6px;
            }
            .badge-success {
                background-color: #28a745;
                color: white;
                padding: 0.3em 0.6em;
                border-radius: 0.25rem;
            }
            .badge-danger {
                background-color: #dc3545;
                color: white;
                padding: 0.3em 0.6em;
                border-radius: 0.25rem;
            }
            .badge-warning {
                background-color: #ffc107;
                color: #212529;
                padding: 0.3em 0.6em;
                border-radius: 0.25rem;
            }
            .badge-secondary {
                background-color: #6c757d;
                color: white;
                padding: 0.3em 0.6em;
                border-radius: 0.25rem;
            }
        </style>
    </head>
    <body>
        <h2>Application Report</h2>
        ${clone.innerHTML}
        <footer style="margin-top: 3rem; font-size: 0.8rem; color: #666;">
          Generated on ${new Date().toLocaleString()}
        </footer>
    </body>
    </html>
    `;

    // Create a Blob from the HTML string
    const blob = new Blob([htmlContent], { type: 'text/html' });

    // Create a download link and simulate click
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Application_Report_${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(link);
    link.click();

    // Cleanup
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
});
</script>


{% endblock %}
