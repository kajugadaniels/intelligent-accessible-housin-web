{% extends 'backend/layouts/app.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body">
                    <div class="list-client-header">
                        <div class="d-flex justify-content-between">
                            <h4>Edit Property: {{ form.instance.name }}</h4>
                            <a class="btn btn-primary" href="{% url 'backend:getProperties' %}"><i class="fa fa-eye"></i> Go Back</a>
                        </div>
                    </div>
                    <hr>
                    <div class="form theme-form">
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ form.non_field_errors }}
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ form.name.label }}</label>
                                    {{ form.name }}
                                    {% for error in form.name.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ form.image.label }}</label>
                                    {{ form.image }}
                                    {% for error in form.image.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">{{ form.city.label }}</label>
                                    {{ form.city }}
                                    {% for error in form.city.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.type.label }}</label>
                                    {{ form.type }}
                                    {% for error in form.type.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.category.label }}</label>
                                    {{ form.category }}
                                    {% for error in form.category.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.address.label }}</label>
                                    {{ form.address }}
                                    {% for error in form.address.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.bathroom.label }}</label>
                                    {{ form.bathroom }}
                                    {% for error in form.bathroom.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.capacity.label }}</label>
                                    {{ form.capacity }}
                                    {% for error in form.capacity.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.size.label }}</label>
                                    {{ form.size }}
                                    {% for error in form.size.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.price_usd.label }}</label>
                                    {{ form.price_usd }}
                                    {% for error in form.price_usd.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">{{ form.price_rwf.label }}</label>
                                    {{ form.price_rwf }}
                                    {% for error in form.price_rwf.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{{ form.amenities.label }}</label>
                                {{ form.amenities }}
                                {% for error in form.amenities.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <h5>Nearby activities</h5>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_hospital.label }}</label>
                                    {{ form.nearby_hospital }}
                                    {% for error in form.nearby_hospital.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_school.label }}</label>
                                    {{ form.nearby_school }}
                                    {% for error in form.nearby_school.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_market.label }}</label>
                                    {{ form.nearby_market }}
                                    {% for error in form.nearby_market.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_transport.label }}</label>
                                    {{ form.nearby_transport }}
                                    {% for error in form.nearby_transport.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_park.label }}</label>
                                    {{ form.nearby_park }}
                                    {% for error in form.nearby_park.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">{{ form.nearby_gym.label }}</label>
                                    {{ form.nearby_gym }}
                                    {% for error in form.nearby_gym.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                            <!-- Field for uploading additional images -->
                            <div class="mb-3">
                                <label class="form-label">Add More Images</label>
                                <input type="file" name="images" class="form-control" multiple>
                                <small class="form-text text-muted">You can upload additional images.</small>
                            </div>
                            <!-- Section to display current additional images -->
                            <div class="mb-3">
                                <label class="form-label">Current Additional Images</label>
                                <div class="row">
                                    {% for img in property.images.all %}
                                        <div class="col-md-3 text-center mb-3 property-image-container">
                                            <img src="{{ img.image.url }}" alt="Property Image" class="img-thumbnail" style="max-height:150px;">
                                            <!-- Delete button with data attribute -->
                                            <button type="button" class="btn btn-danger btn-sm mt-1 delete-property-image" data-image-id="{{ img.id }}">
                                                Delete
                                            </button>
                                        </div>
                                    {% empty %}
                                        <p>No additional images available.</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- ——————— New Location & Map Section ——————— -->
                            <h5>Location & Map</h5>
                            <div class="mb-3">
                                <label class="form-label">{{ form.location.label }}</label>
                                {{ form.location }}
                                {% for error in form.location.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{{ form.map_embed.label }}</label>
                                {{ form.map_embed }}
                                {% for error in form.map_embed.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <!-- ——————— New Video Section ——————— -->
                            <h5>Video Tour</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ form.video_url.label }}</label>
                                    {{ form.video_url }}
                                    {% for error in form.video_url.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">{{ form.video_thumbnail.label }}</label>
                                    {{ form.video_thumbnail }}
                                    {% for error in form.video_thumbnail.errors %}
                                        <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">{{ form.description.label }}</label>
                                {{ form.description }}
                                {% for error in form.description.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="row mt-2">
                                <div class="col">
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">Update Property</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrfToken = getCookie('csrftoken');
    
        const deleteButtons = document.querySelectorAll('.delete-property-image');
        deleteButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const imageId = this.dataset.imageId;
                if (confirm('Are you sure you want to delete this image?')) {
                    const url = "{% url 'backend:deletePropertyImage' 0 %}".replace('0', imageId);
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success) {
                            button.closest('.property-image-container').remove();
                        } else {
                            alert(data.error || 'Error deleting image.');
                        }
                    })
                    .catch(error => {
                        alert('Error deleting image.');
                        console.error(error);
                    });
                }
            });
        });
    });
</script>
{% endblock %}
